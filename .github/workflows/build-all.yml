name: 统一构建所有版本内核

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSU分支'
        required: true
        type: choice
        default: 'sukisu'
        options:
          - 'sukisu'
          - 'ksunext'
          - 'mksu'
          - 'ksu'
      susfs_enable:
        description: '是否开启susfs'
        required: true
        type: boolean
        default: true
      kpm_enable:
        description: '是否开启kpm(仅对sukisu生效)'
        required: true
        type: boolean
        default: false
      lz4_enable:
        description: '是否安装 lz4 1.10.0+zstd 1.5.7 补丁'
        required: true
        type: boolean
        default: true
      lz4kd_enable:
        description: '是否安装 LZ4KD 补丁'
        required: true
        type: boolean
        default: false
      bbr_enable:
        description: 'BBR算法(false关闭/true仅加入/default设为默认)'
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'true'
          - 'default'
      better_net:
        description: '是否开启网络功能拓展配置'
        required: true
        type: boolean
        default: false
      adios_enable:
        description: '是否启用ADIOS IO调度器支持'
        required: true
        type: boolean
        default: true
      rekernel_enable:
        description: '是否启用Re-Kernel支持'
        required: true
        type: boolean
        default: false
      baseband_guard:
        description: '是否开启内核级基带保护'
        required: true
        type: boolean
        default: true
      # 选择要构建的版本 - 支持: 30,50,56,57,66,89,89_mtk 或 all
      build_versions:
        description: '构建版本(逗号分隔,如: 89,66 或 all构建全部)'
        required: true
        type: string
        default: '89'
      kernel_suffix:
        description: '自定义内核后缀(留空使用默认)'
        required: false
        type: string
        default: ''

env:
  TZ: Asia/Shanghai

jobs:
  # ==================== 6.6.30 ====================
  build-6-6-30:
    if: ${{ inputs.build_versions == 'all' || contains(inputs.build_versions, '30') }}
    uses: ./.github/workflows/fastbuild_6.6.30.yml
    secrets: inherit
    with:
      ksu_type: ${{ inputs.ksu_type }}
      susfs_enable: ${{ inputs.susfs_enable }}
      kpm_enable: ${{ inputs.kpm_enable }}
      lz4_enable: ${{ inputs.lz4_enable }}
      lz4kd_enable: ${{ inputs.lz4kd_enable }}
      bbr_enable: ${{ inputs.bbr_enable }}
      better_net: ${{ inputs.better_net }}
      adios_enable: ${{ inputs.adios_enable }}
      rekernel_enable: ${{ inputs.rekernel_enable }}
      baseband_guard: ${{ inputs.baseband_guard }}
      kernel_suffix: ${{ inputs.kernel_suffix }}
      skip_release: true

  # ==================== 6.6.50 ====================
  build-6-6-50:
    if: ${{ inputs.build_versions == 'all' || contains(inputs.build_versions, '50') }}
    uses: ./.github/workflows/fastbuild_6.6.50.yml
    secrets: inherit
    with:
      ksu_type: ${{ inputs.ksu_type }}
      susfs_enable: ${{ inputs.susfs_enable }}
      kpm_enable: ${{ inputs.kpm_enable }}
      lz4_enable: ${{ inputs.lz4_enable }}
      lz4kd_enable: ${{ inputs.lz4kd_enable }}
      bbr_enable: ${{ inputs.bbr_enable }}
      better_net: ${{ inputs.better_net }}
      adios_enable: ${{ inputs.adios_enable }}
      rekernel_enable: ${{ inputs.rekernel_enable }}
      baseband_guard: ${{ inputs.baseband_guard }}
      kernel_suffix: ${{ inputs.kernel_suffix }}
      skip_release: true

  # ==================== 6.6.56 ====================
  build-6-6-56:
    if: ${{ inputs.build_versions == 'all' || contains(inputs.build_versions, '56') }}
    uses: ./.github/workflows/fastbuild_6.6.56.yml
    secrets: inherit
    with:
      ksu_type: ${{ inputs.ksu_type }}
      susfs_enable: ${{ inputs.susfs_enable }}
      kpm_enable: ${{ inputs.kpm_enable }}
      lz4_enable: ${{ inputs.lz4_enable }}
      lz4kd_enable: ${{ inputs.lz4kd_enable }}
      bbr_enable: ${{ inputs.bbr_enable }}
      better_net: ${{ inputs.better_net }}
      adios_enable: ${{ inputs.adios_enable }}
      rekernel_enable: ${{ inputs.rekernel_enable }}
      baseband_guard: ${{ inputs.baseband_guard }}
      kernel_suffix: ${{ inputs.kernel_suffix }}
      skip_release: true

  # ==================== 6.6.57 ====================
  build-6-6-57:
    if: ${{ inputs.build_versions == 'all' || contains(inputs.build_versions, '57') }}
    uses: ./.github/workflows/fastbuild_6.6.57.yml
    secrets: inherit
    with:
      ksu_type: ${{ inputs.ksu_type }}
      susfs_enable: ${{ inputs.susfs_enable }}
      kpm_enable: ${{ inputs.kpm_enable }}
      lz4_enable: ${{ inputs.lz4_enable }}
      lz4kd_enable: ${{ inputs.lz4kd_enable }}
      bbr_enable: ${{ inputs.bbr_enable }}
      better_net: ${{ inputs.better_net }}
      adios_enable: ${{ inputs.adios_enable }}
      rekernel_enable: ${{ inputs.rekernel_enable }}
      baseband_guard: ${{ inputs.baseband_guard }}
      kernel_suffix: ${{ inputs.kernel_suffix }}
      skip_release: true

  # ==================== 6.6.66 ====================
  build-6-6-66:
    if: ${{ inputs.build_versions == 'all' || contains(inputs.build_versions, '66') }}
    uses: ./.github/workflows/fastbuild_6.6.66.yml
    secrets: inherit
    with:
      ksu_type: ${{ inputs.ksu_type }}
      susfs_enable: ${{ inputs.susfs_enable }}
      kpm_enable: ${{ inputs.kpm_enable }}
      lz4_enable: ${{ inputs.lz4_enable }}
      lz4kd_enable: ${{ inputs.lz4kd_enable }}
      bbr_enable: ${{ inputs.bbr_enable }}
      better_net: ${{ inputs.better_net }}
      adios_enable: ${{ inputs.adios_enable }}
      rekernel_enable: ${{ inputs.rekernel_enable }}
      baseband_guard: ${{ inputs.baseband_guard }}
      kernel_suffix: ${{ inputs.kernel_suffix }}
      skip_release: true

  # ==================== 6.6.89 ====================
  build-6-6-89:
    if: ${{ inputs.build_versions == 'all' || contains(inputs.build_versions, '89') }}
    uses: ./.github/workflows/fastbuild_6.6.89.yml
    secrets: inherit
    with:
      ksu_type: ${{ inputs.ksu_type }}
      susfs_enable: ${{ inputs.susfs_enable }}
      kpm_enable: ${{ inputs.kpm_enable }}
      lz4_enable: ${{ inputs.lz4_enable }}
      lz4kd_enable: ${{ inputs.lz4kd_enable }}
      bbr_enable: ${{ inputs.bbr_enable }}
      better_net: ${{ inputs.better_net }}
      adios_enable: ${{ inputs.adios_enable }}
      rekernel_enable: ${{ inputs.rekernel_enable }}
      baseband_guard: ${{ inputs.baseband_guard }}
      kernel_suffix: ${{ inputs.kernel_suffix }}
      skip_release: true

  # ==================== 6.6.89_mtk ====================
  build-6-6-89-mtk:
    if: ${{ inputs.build_versions == 'all' || contains(inputs.build_versions, '89_mtk') }}
    uses: ./.github/workflows/fastbuild_6.6.89_mtk.yml
    secrets: inherit
    with:
      ksu_type: ${{ inputs.ksu_type }}
      susfs_enable: ${{ inputs.susfs_enable }}
      kpm_enable: ${{ inputs.kpm_enable }}
      lz4_enable: ${{ inputs.lz4_enable }}
      lz4kd_enable: ${{ inputs.lz4kd_enable }}
      bbr_enable: ${{ inputs.bbr_enable }}
      better_net: ${{ inputs.better_net }}
      adios_enable: ${{ inputs.adios_enable }}
      rekernel_enable: ${{ inputs.rekernel_enable }}
      baseband_guard: ${{ inputs.baseband_guard }}
      kernel_suffix: ${{ inputs.kernel_suffix }}
      skip_release: true

  # ==================== 统一发布 ====================
  release:
    runs-on: ubuntu-latest
    needs: 
      - build-6-6-30
      - build-6-6-50
      - build-6-6-56
      - build-6-6-57
      - build-6-6-66
      - build-6-6-89
      - build-6-6-89-mtk
    if: |
      always() && 
      (needs.build-6-6-30.result == 'success' || needs.build-6-6-30.result == 'skipped') &&
      (needs.build-6-6-50.result == 'success' || needs.build-6-6-50.result == 'skipped') &&
      (needs.build-6-6-56.result == 'success' || needs.build-6-6-56.result == 'skipped') &&
      (needs.build-6-6-57.result == 'success' || needs.build-6-6-57.result == 'skipped') &&
      (needs.build-6-6-66.result == 'success' || needs.build-6-6-66.result == 'skipped') &&
      (needs.build-6-6-89.result == 'success' || needs.build-6-6-89.result == 'skipped') &&
      (needs.build-6-6-89-mtk.result == 'success' || needs.build-6-6-89-mtk.result == 'skipped') &&
      (needs.build-6-6-30.result == 'success' || needs.build-6-6-50.result == 'success' || 
       needs.build-6-6-56.result == 'success' || needs.build-6-6-57.result == 'success' ||
       needs.build-6-6-66.result == 'success' || needs.build-6-6-89.result == 'success' ||
       needs.build-6-6-89-mtk.result == 'success')
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: 下载所有内核工件
        uses: actions/download-artifact@v4
        with:
          path: ./release_zips
          pattern: Kernel_*
          merge-multiple: true

      - name: 列出已下载的文件
        run: |
          echo "已下载的文件列表:"
          find ./release_zips -type f -name "*.zip" | sort

      - name: 设置环境变量
        run: |
          TIME="$(TZ='Asia/Shanghai' date +'%y%m%d%H%M%S')"
          TIME_FORM="$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          echo "TIME=$TIME" >> $GITHUB_ENV
          echo "TIME_FORM=$TIME_FORM" >> $GITHUB_ENV
          TAG_HEAD="OPPO+OPlus+Realme-SM8750-build"
          echo "TAG_HEAD=$TAG_HEAD" >> $GITHUB_ENV
          
          # 确定 KSU 类型名称
          if [[ "${{ inputs.ksu_type }}" == "sukisu" ]]; then
            KSU_TYPENAME="SukiSU Ultra"
          elif [[ "${{ inputs.ksu_type }}" == "ksunext" ]]; then
            KSU_TYPENAME="KernelSU Next"
          elif [[ "${{ inputs.ksu_type }}" == "mksu" ]]; then
            KSU_TYPENAME="MKSU"
          else
            KSU_TYPENAME="KernelSU (Official)"
          fi
          echo "KSU_TYPENAME=$KSU_TYPENAME" >> $GITHUB_ENV
          
          # 构建版本列表
          VERSIONS=""
          BUILD_VERSIONS="${{ inputs.build_versions }}"
          if [[ "$BUILD_VERSIONS" == "all" ]]; then
            VERSIONS="6.6.30,6.6.50,6.6.56,6.6.57,6.6.66,6.6.89,6.6.89_mtk"
          else
            if [[ "$BUILD_VERSIONS" == *"30"* ]]; then
              VERSIONS="${VERSIONS}6.6.30,"
            fi
            if [[ "$BUILD_VERSIONS" == *"50"* ]]; then
              VERSIONS="${VERSIONS}6.6.50,"
            fi
            if [[ "$BUILD_VERSIONS" == *"56"* ]]; then
              VERSIONS="${VERSIONS}6.6.56,"
            fi
            if [[ "$BUILD_VERSIONS" == *"57"* ]]; then
              VERSIONS="${VERSIONS}6.6.57,"
            fi
            if [[ "$BUILD_VERSIONS" == *"66"* ]]; then
              VERSIONS="${VERSIONS}6.6.66,"
            fi
            if [[ "$BUILD_VERSIONS" == *"89_mtk"* ]]; then
              VERSIONS="${VERSIONS}6.6.89_mtk,"
            elif [[ "$BUILD_VERSIONS" == *"89"* ]]; then
              VERSIONS="${VERSIONS}6.6.89,"
            fi
            # 移除末尾逗号
            VERSIONS="${VERSIONS%,}"
          fi
          echo "VERSIONS=$VERSIONS" >> $GITHUB_ENV

      - name: 创建统一发布
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ env.TAG_HEAD }}-${{ env.TIME }}"
          name: "${{ env.KSU_TYPENAME }} 多版本统一构建 - ${{ env.TIME_FORM }}"
          body: |
            ### 欧加真 ${{ env.KSU_TYPENAME }} SM8750 通用内核 | 统一构建
            
            #### 本次构建包含以下版本:
            ${{ env.VERSIONS }}
            
            #### 构建配置:
            | 配置项 | 状态 |
            |--------|------|
            | KSU分支 | ${{ env.KSU_TYPENAME }} |
            | susfs支持 | ${{ inputs.susfs_enable && '是' || '否' }} |
            | KPM支持 | ${{ inputs.kpm_enable && '是' || '否' }} |
            | LZ4 1.10.0 + ZSTD | ${{ inputs.lz4_enable && '是' || '否' }} |
            | LZ4KD | ${{ inputs.lz4kd_enable && '是' || '否' }} |
            | 网络功能增强 | ${{ inputs.better_net && '是' || '否' }} |
            | BBR算法 | ${{ inputs.bbr_enable }} |
            | ADIOS IO调度器 | ${{ inputs.adios_enable && '是' || '否' }} |
            | Re-Kernel | ${{ inputs.rekernel_enable && '是' || '否' }} |
            | 基带保护 | ${{ inputs.baseband_guard && '是' || '否' }} |
            
            #### 管理器下载:
            - SukiSU Ultra: [下载](https://github.com/SukiSU-Ultra/SukiSU-Ultra/releases)
            - KernelSU Next: [下载](https://github.com/KernelSU-Next/KernelSU-Next/releases)
            - MKSU: [下载](https://github.com/5ec1cff/KernelSU/actions)
            - KernelSU 原版: [下载](https://github.com/tiann/KernelSU/releases)
            
            #### 安装方法:
            1. 已有Recovery(TWRP): 下载对应版本AnyKernel包，进入Recovery刷入
            2. 已Root: 使用[HorizonKernelFlasher](https://github.com/libxzr/HorizonKernelFlasher/releases)刷入
            3. SukiSU用户: 可在管理器中直接刷入
            
            #### 注意事项:
            - 刷写内核有风险，请先备份boot分区！
            - 请使用[KernelFlasher](https://github.com/capntrips/KernelFlasher)备份
            - 新版KSU需要配合元模块使用
            
            ---
            编译时间: ${{ env.TIME_FORM }}
          draft: false
          prerelease: false
          files: |
            release_zips/*.zip
